<!DOCTYPE html>
<html lang="en">
<head>
	<title>Scrum Master</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Helvetica, Sans-Serif, sans-serif;
			font-size: 12px;
		}

		h5 {
			font-size: 14px;
			margin-top: 10px;
			margin-bottom: 3px;
		}
		tr td:first-child {
			text-align: center;
		}

		.normal {
		}

		.current {
			font-weight: bold;
		}

		.completed {
			text-decoration: line-through;
			color: grey;
		}

		.disabled {
			color: darkred;
		}
	</style>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
<table style="width:100%;">
	<tr>
		<td colspan="3" style="text-align: left;">
			<span id="today" style="font-weight: 600;"></span>&nbsp;<span id="statusIndicator"><i
				class="fas fa-spinner"></i></span>
		</td>
	</tr>
	<tr>
		<td style="text-align: left; width: 48%;">
			<h5 id="firstWeekTitle">1.</h5>
			<div id="firstWeek"></div>
			<h5 id="secondWeekTitle">2.</h5>
			<div id="secondWeek"></div>
		</td>
		<td style="width: 2%;">&nbsp;</td>
		<td style="vertical-align: top; width: 50%;">
			<h5>Who's Out</h5>
			<div id="whosOut"></div>
		</td>
	</tr>
</table>
<script>
	class MyData {
		_data = {
			dayRules: [],
			holidays: [],
			teamMembers: []
		};
		_hasCashedData = false;
		_cashDataNotAllowed = false;
		_isLoading = false;
		_today = new Date();
		constructor() {
			try {
				const cachedData = localStorage.getItem('myCachedData');
				if (cachedData) {
					this._hasCashedData = true;
					this._data = JSON.parse(cachedData);
				}
			} catch (e) {
				this._cashDataNotAllowed = true;
			}
			this._isLoading = true;
			fetch('https://script.google.com/macros/s/AKfycbwDmyGYn0W7UQPEiDiVzqv35qTigkn-RsGA0FdHNXsROchisP_6_Og0-DNHi0Z2kGsRnw/exec')
					.then(response => {
						return response.text();
					})
					.then(text => {
						this._isLoading = false;
						const jsonData = JSON.parse(text.toString());
						this._data = JSON.parse(JSON.stringify(jsonData));
						if (!this._cashDataNotAllowed) {
							localStorage.setItem('myCachedData', JSON.stringify(jsonData));
						}
					})
					.then(refresh)
					.catch(error => console.error("Error:", error));
		}
		
		get today() {
			return new Date(this._today);
		}

		get isLoading() {
			return this._isLoading;
		}
		
		get isInitializing() {
			return this._isLoading && !this._hasCashedData;
		}

		get hasCashedData() {
			return this._hasCashedData;
		}
		
		get cashDataNotAllowed() {
			return this._cashDataNotAllowed;
		}
		
		get dayRules() {
			return (this._data.dayRules ? this._data.dayRules : [])
					.map(item => ({
						memberId: item.memberId,
						type: item.type,
						start: justDate(item.start),
						end: justDate(item.end),
						reason: item.reason
					}));
		}

		get specialDays() {
			return this.dayRules.filter(item => item.type === "Replacement");
		}

		get vacations() {
			return this.dayRules.filter(item => item.type === "Vacation");
		}

		get holidays() {
			return (this._data.holidays ? this._data.holidays : [])
					.map(item => ({
						date: justDate(item.date),
						name: item.name
					}));
		}

		get whosOut() {
			return this.vacations
					.filter(item => item.end >= addDays(this._today, -30) && item.start <= addDays(this._today, 60))
					.map(item => (
							{
								start: item.start,
								end: item.end,
								memberId: item.memberId,
								reason: item.reason,
								status: isBetween(item.start, item.end, this._today)
										? 0
										: isFinished(item.end, this._today)
												? -1 : 1
							}
					))
					.sort((a, b) => a.status !== b.status ? a.status - b.status : a.start - b.start);
		}
		
		get teamMembers() {
			return (this._data.teamMembers ? this._data.teamMembers : [])
					.filter(item => item.status === "Active")
					.map(item => (
							{
								memberId: item.memberId,
								name: item.name,
								shortName: item.shortName,
								status: item.status,
								peekOrder: item.peekOrder,
								dayBackup: item.dayBackup,
								backupMembers: item.backupMembers && item.backupMembers.trim() !== ''
										? item.backupMembers.split(',').map(m => m.trim())
										: []
							}));
		}

		getTeamMember(memberId) {
			return this.teamMembers
					.filter(item => item.memberId === memberId)[0];
		}
	}

	let myData = new MyData();

	const firstWeekTeamMembers = ["SĐ", "SJ", "ML", "SR", "NS"];
	const secondWeekTeamMembers = ["RŠ", "MS", "MA", "MS", "MA"];

	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	function getSpecialScrumMaster(date) {
		for (let days of myData.specialDays) {
			if (date >= days.start && date < addDays(days.end, 1)) {
				return days;
			}
		}
		return null;
	}

	function isOnVacation(date, memberId) {
		return myData.vacations.some(v => v.memberId === memberId && date >= v.start && date < addDays(v.end, 1));
	}
	
	
	function currentHoliday(date) {
		return myData.holidays.filter(h => formatFullDate(h.date) === formatFullDate(date));
	}
	
	function isHoliday(date) {
		const filter = currentHoliday(date);
		return filter.length > 0;
	}

	function getHolidayName(date) {
		return currentHoliday(date)[0].name;
	}
	
	function getFirstFreeBackup(date, memberId) {
		const backupMembers = myData.getTeamMember(memberId).backupMembers;
		if (backupMembers.length > 0) {
			for (let backupMemberId of backupMembers) {
				if (!isOnVacation(date, backupMemberId)) {
					return backupMemberId;
				}
			}
		}
		let seed = getDateSeed(date);
		let shuffledTeamMembers = shuffleArray([...myData.teamMembers], seed);
		for (let member of shuffledTeamMembers) {
			if (!isOnVacation(date, member.memberId)) {
				return member.memberId;
			}
		}
		return null;
	}

	function shuffleArray(array, seed) {
		let currentIndex = array.length, temporaryValue, randomIndex;

		function seededRandom() {
			const x = Math.sin(seed++) * 10000;
			return x - Math.floor(x);
		}

		while (0 !== currentIndex) {

			randomIndex = Math.floor(seededRandom() * currentIndex);
			currentIndex -= 1;

			temporaryValue = array[currentIndex];
			array[currentIndex] = array[randomIndex];
			array[randomIndex] = temporaryValue;
		}

		return array;
	}

	function getDateSeed(date) {
		return date.getFullYear() * 10000 + (date.getMonth() + 1) * 100 + date.getDate();
	}

	function generateWeeks(selector, today, teamMembers, firstMonday, isActiveWeek) {
		const todayDay = today.getDay();
		const dayElement = document.querySelector(selector);
		dayElement.innerHTML = "";

		for (let i = 0; i < daysOfWeek().length - 2; i++) {
			const currentDay = addDays(firstMonday, i, todayDay);
			let text = getDayOfWeek(i).substring(0, 3);
			if (isHoliday(currentDay)) {
				text = `<span class="disabled">${text} - ${getHolidayName(currentDay)}</span>`;
			} else {
				const specialScrumMaster = getSpecialScrumMaster(currentDay);
				let scrumMasterId = teamMembers[i];
				if (specialScrumMaster != null) {
					scrumMasterId = specialScrumMaster.memberId;
				}
				if (isOnVacation(currentDay, scrumMasterId)) {
					scrumMasterId = getFirstFreeBackup(currentDay, scrumMasterId);
				}
				const scrumMaster = myData.getTeamMember(scrumMasterId)
				let scrumMasterName;
				if (scrumMaster) {
					scrumMasterName = scrumMaster.name;
				} else if (myData.isInitializing) {
					scrumMasterName = "initializing...";
				} else {
					scrumMasterName = "Unknown";
				}
				
				text += ` - ${scrumMasterName}`;

				if (isActiveWeek && todayDay === (i + 1)) {
					text = `<b class="current" style="color: darkgreen; font-weight: 900;">${text}</b>`;
				} else if (isFinished(currentDay, today)) {
					text = `<s class="completed">${text}</s>`;
				}
			}

			dayElement.innerHTML += `${text}<br>`;
		}
	}

	function updateTitleWithWeekNumber(selector, firstDay, isActiveWeek) {
		const lastDay = addDays(firstDay, 4);
		const titleElement = document.querySelector(selector);
		titleElement.style.fontWeight = isActiveWeek ? 'bold' : 'normal';
		titleElement.innerHTML = `Week ${formatDate(firstDay)}-${formatDate(lastDay)}:`;
	}

	function updateWhosOut() {
		const whosOutElement = document.querySelector("#whosOut");
		if (myData.isInitializing) {
			whosOutElement.innerHTML = "initializing...";
		} else {
			let innerHTML = '<ul style="padding-left: 2em;">';
			for (let item of myData.whosOut) {
				let itemHTML = myData.getTeamMember(item.memberId).shortName;
				itemHTML += "&nbsp;";
				itemHTML += formatDatePeriod(item.start, item.end);
				if (item.status === 0) {
					innerHTML += `<li class="current">${itemHTML}</li>`;
				} else if (item.status < 0) {
					innerHTML += `<li class="completed">${itemHTML}</li>`;
				} else {
					innerHTML += `<li class="normal">${itemHTML}</li>`;
				}
			}
			innerHTML += "</ul>";
			whosOutElement.innerHTML = innerHTML;
		}
	}

	function isBetween(start, end, today) {
		return start <= today && addDays(end, 1) > today;
	}

	function isFinished(end, today) {
		return end < today;
	}

	function formatDatePeriod(start, end) {
		if (formatDate(start) === formatDate(end)) {
			return formatDate(start);
		}
		return `${formatDate(start)}-${formatDate(end)}`;
	}

	function formatDate(date) {
		const day = String(date.getDate()).padStart(2, '0');
		const month = String(date.getMonth() + 1).padStart(2, '0');
		return `${day}.${month}`;
	}
	
	function formatFullDate(date) {
		const day = String(date.getDate()).padStart(2, '0');
		const month = String(date.getMonth() + 1).padStart(2, '0');
		const year = String(date.getFullYear() + 1).padStart(4, '0');
		return `${year}-${month}-${day}`;
	}

	function updateToday(date) {
		const todayElement = document.querySelector("#today");
		todayElement.innerHTML = `${formatDate(date)}.${date.getFullYear()} - ${getDayOfWeek((date.getDay() + 6) % 7)}`;
	}

	function justDate(date) {
		const d = new Date(date);
		d.setHours(0, 0, 0, 0);
		return d;
	}

	function getMonday(d) {
		const date = new Date(d);
		const day = date.getDay();
		const diff = date.getDate() - day + (day === 0 ? -6 : 1);
		return new Date(date.setDate(diff));
	}

	function CurrentWeekNumberFromFixedDate(date) {
		return Math.ceil((date - new Date(2023, 0, 2)) / 604800000);
	}

	function IsFirstWeekCurrentWeek(date) {
		return CurrentWeekNumberFromFixedDate(date) % 2 === 0;
	}

	function addDays(date, days) {
		const newDate = new Date(date);
		newDate.setDate(newDate.getDate() + days);
		return newDate;
	}

	function getDayOfWeek(day) {
		return daysOfWeek()[day];
	}

	function daysOfWeek() {
		return ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
	}
	
	function nonWorkingDay(date) {
		return date.getDay() === 6 || date.getDay() === 0;
	}

	function refresh() {
		const statusIndicator = document.getElementById('statusIndicator');
		const today = addDays(myData.today, 0);

		const isFirstWeekCurrentWeek = IsFirstWeekCurrentWeek(today);
		const isSecondWeekCurrentWeek = !isFirstWeekCurrentWeek;

		const thisMonday = getMonday(today);
		const firstMonday = isFirstWeekCurrentWeek ? new Date(thisMonday) : addDays(thisMonday, -7);
		const secondMonday = isSecondWeekCurrentWeek ? new Date(thisMonday) : addDays(thisMonday, 7)

		updateToday(today);

		generateWeeks("#firstWeek", today, firstWeekTeamMembers, firstMonday, isFirstWeekCurrentWeek);
		generateWeeks("#secondWeek", today, secondWeekTeamMembers, secondMonday, isSecondWeekCurrentWeek);

		updateTitleWithWeekNumber("#firstWeekTitle", firstMonday, isFirstWeekCurrentWeek);
		updateTitleWithWeekNumber("#secondWeekTitle", secondMonday, isSecondWeekCurrentWeek);

		updateWhosOut();

		if (myData.isLoading) {
			if (myData.hasCashedData) {
				statusIndicator.innerHTML = '<i class="fas fa-wifi"></i>';
			} else {
				statusIndicator.innerHTML = "";
			}
			statusIndicator.innerHTML += '&nbsp;<i class="fas fa-spinner fa-spin"></i>'
		} else {
			statusIndicator.innerHTML = '<i class="fas fa-check"></i>';
			setTimeout(removeStatusIndicator, 5000);
		}
		
		if (myData.cashDataNotAllowed) {
			statusIndicator.innerHTML += '&nbsp;<i class="fas fa-exclamation-triangle"></i>'
		}
		if (nonWorkingDay(today)) {
			statusIndicator.innerHTML += '&nbsp;<i class="fas fa-bed"></i>'
		}
		if (isHoliday(today)) {
			statusIndicator.innerHTML += '&nbsp;<i class="fas fa-gift"></i>'
		}
	}
	
	function removeStatusIndicator() {
		const statusIndicator = document.getElementById('statusIndicator');
		if (statusIndicator) {
			statusIndicator.innerHTML = statusIndicator.innerHTML.replace('<i class=\"fas fa-check\"></i>', '');
		}
	}

	refresh();
</script>
</body>
</html>